---
layout: post
title: New Ruby On Rails Tutorial with sqlserver under windows and linux environment
---

## Why?
Ruby on rails tutorial from Michael Hartl is good. It is well structured with concrete example. However, it is based on rails 4.0. For example, Rails 4.1 comes with Spring for application preloader. Trying to follow the Spork instruction in his book is a bit tough under the Rails 4.1 environment. And Rspec as well. **I will follow each steps from his tutorial but with simpler and newer instructions**. Although he is updating the tutorial to 4.1 version now.

## Install ruby and set up Rails
### Ubuntu 14.04
After I play around with rvm and rbenv, I settled down to rbenv. [Good instructions to install and setup on Ubuntu 14.04.](https://gorails.com/setup/ubuntu/14.04) To use sqlserver with tiny_tds, 'freetds' needs to be installed. [Here's instruction to install in Ubuntu.](https://github.com/rails-sqlserver/activerecord-sqlserver-adapter/wiki/Platform-Installation---Ubuntu)

### Windows
I installed it with [RubyInstaller.](http://rubyinstaller.org/downloads) To install Jekyll on Windows I happened to install Ruby DevKit as well. It might be needed in the future for gems requiring the dependency. [Here is the instruction to install Ruby DevKit](http://jekyll-windows.juthilo.com/1-ruby-and-devkit) 


## Test the Rails setup
### Install Gems and scaffold the project
Installing rails gem is simple. ```gem install rails``` Scaffold the project to use sqlserver as database.

```
rails new my-project-name --database=sqlserver --git
```

To use sqlserver from Rails, we need to set up more gems. [Follow the instruction from TinyTDS.](https://github.com/rails-sqlserver/activerecord-sqlserver-adapter/wiki/Using-TinyTds) Make sure tiny_tds is included in the Gemfile as well.

```
gem 'tiny_tds'
gem 'activerecord-sqlserver-adapter'
```

### test run it

```
rails server
rails server -e production
``` 

On windows 64-bit ruby, ```No source of timezone data could be found. (TZInfo::DataSourceNotFound)``` error will pop up.  [This can be fixed by configuring Gemfile.](http://stackoverflow.com/questions/23022258/tzinfodatasourcenotfound-error-starting-rails-v4-1-0-server-on-windows) The Gemfile should have this.

```gem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw]```

After editing the Gemfile, don't forget to do ```bundle update```.

When run rails in production envrionment, ```ERROR RuntimeError: Missing `secret_key_base` for 'production' environment, set this value in `config/secrets.yml` ``` error will pop up. There are couple of ways to fix this problem.

* Use figaro gem and [set it up](https://github.com/laserlemon/figaro)
* Windows, in Computer > Property> Advanced system settings > Envrionment Variables..., add the environment variable 'SECRET\_KEY\_BASE'
* Linux, add the enironment variable to the shell.

The secret key can be generated by ```rake seceret```


### Change the database configuration in database.yml and test the connection

```yaml
default: &default
	# I'm not using the dataserver. So, I have to add host
	# dataserver: from_freetds.conf 
	host: your_ip_or_host_name
	username: your_name
	password: your_password
```

To test the database connection is working, create test model and run rails console to play around with the model.

```ruby
rails generate model User name:string email:string
rake db:migrate
rails console --sandbox

>> user = User.new(name: 'Test', email:'test@test.com')
=> #>User id:nil, name: "test", ...
>> user.save
SQL (40.0ms) SAVE TRANSACTION ...
=> true
>> User.all
User Load (41.0ms) ...
=> #<ActiveRecord::Relation ...
>> exit
```

Done. rollback the database from the test and destroy the test model as well.

```
rake db:rollback
rails destroy model User
```

## Install Phusion Passenger with nginx version and set up
### How to install on Ubuntu
[Follow this instruction](https://www.phusionpassenger.com/documentation/Users%20guide%20Nginx.html#install_on_debian_ubuntu)

### How I set up /etc/nginx/nginx.conf
Just like the manual, I uncomment the passenger\_root. For passenger\_ruby, since I am using rbenv, I check the path by `which ruby` and use the path.

```
passenger_root /usr/lib/ruby/vendor_ruby/phusion_passenger/locations.ini;
passenger_ruby /home/user_name/.rbenv/shims/ruby;
```



## Various Scaffolding 

### Scaffold model to use table from already existing database
Let's say we already have table named 'UserResult' in our existing database. How can we scaffold our model to use the table? The name 'UserResult' is a bit different from what we usually get when we scaffold model from rails. How to connect the ActiveRecord model with the table correctly? After ```rails generate scaffold UserResult --no-migration``` we need to set the table\_name for the class UserResult in user_result.rb file.

```ruby
class UserResult < ActiveRecord::Base
  self.table_name = 'UserResult'
end
```

### Scaffold model from existing table with composite primary key
Rails ActiveRecord doesn't support composite key unfortunately. Even though the existing table doesn't have id column as primary_key and the table has composite primary keys, we can connect our ActiveRecord model to the database table with this [composite-primary-keys](https://github.com/composite-primary-keys/composite_primary_keys) gem. The model should look like this.

```ruby
class UserResult < ActiveRecord::Base
  self.table_name = 'UserResult'
  self.primary_keys = :JoinDate, :Subject, :Name
end
```

### Scaffold model without timestamps
```
rails generate model test --timestamps=false
```


### Scaffold model and change migration to get composite primary key working
First generate scaffold as usual with migration.

```
rails generate scaffold Student roll_no:integer, name:string, grade:integer
```

After that, let's change migration file. Many tricks used.

* [reversible](http://guides.rubyonrails.org/migrations.html#using-reversible) should be used to ensure the custom primary key will be dropped when we rollback the migration
* [change\_column\_null](http://stackoverflow.com/questions/5966840/how-to-change-a-nullable-column-to-not-nullable-in-a-rails-migration/22994790#22994790) is better solution to change the generated column to be not null in rails 4+
* execute SQL using [herdoc](http://stackoverflow.com/questions/2337510/ruby-can-i-write-multi-line-string-with-no-concatenation) will make the code look better

```ruby
class CreateStudents < ActiveRecord::Migration
  def change
    create_table :students do |t|
      t.integer :roll_no
      t.string :name
      t.integer :grade

      t.timestamps
    end

    change_column_null(:students, :roll_no, false)
    change_column_null(:students, :name, false)

    reversible do |dir|
      dir.up do
        remove_column :students, :id
        execute <<-SQL
          ALTER TABLE students
            ADD CONSTRAINT pk_roll_name
            PRIMARY KEY (roll_no, name)
        SQL
      end

      dir.down do
        execute <<-SQL
          ALTER TABLE students
            DROP CONSTRAINT pk_roll_name
        SQL
      end

    end
  end
end
```


## Look & Feel
## Create static pages
### Scaffold static pages

```
rails generate controller StaticPages home help
```


### set up the routes
Open config/routes.rb and edit the routes.

```ruby
root 'static_pages#home'
get 'help' => 'static_pages#help'
```

It is giving us named routes of root\_path, help\_path as well. Having `get 'home' => 'static_pages#home'` is not really good idea. It is hard to test the routes since the result path will be '/' from `assert_routing '/home', controller: 'static_pages', action: 'home'` test instead of '/home'. You can use assert_recognizes to test though.
